#!/bin/bash
#
# Ben Fasoli
#
# Convenience script to ensure code is fetched from different sources and
# fortran binaries and DLLs are compiled and moved to the correct location

set -e

# Check if ./setup is run from the top level of the project
dircnt=$(ls -d */ | grep -x -e exe/ -e r/ -e fortran/ | wc -l)
if [ $dircnt -lt 3 ]; then
  echo "./setup must be run from the top level directory of the STILT project"
  exit 1
fi

# Compile permute DLL for footprint kernel aggregation
echo "Compiling footprint kernel aggregation subroutine..."
R CMD SHLIB r/src/permute.f90
if [ ! -s r/src/permute.so ]; then
  echo "Problem compiling r/src/permute.so."
  exit 1
fi

if [[ "$OSTYPE" == "linux-gnu" ]]; then
  install="1"
elif [[ "$OSTYPE" == "darwin"* ]]; then
  install="2"
else
  echo "
  STILT hycs_std installation options:
  1 - linux_x64
  2 - macos_x64
  9 - Compile hycs_std from source (unavailable)
  "
  echo -n "Install option (number from above): "
  read -n 1 install
  echo
fi

if [[ $install -eq 1 ]]; then
  cp fortran/linux_x64/hycs_std exe/
elif [[ $install -eq 2 ]]; then
  cp fortran/macos_x64/hycs_std exe/
else
  echo "Invalid install option."
  exit 1
fi

# Check that hycs_std was created from methods above
if [ ! -s exe/hycs_std ]; then
  echo "Problem installing hycs_std"
  exit 1
fi
# Ensure hysplit, run_stilt.r, and stilt_cli.r are executable
chmod +x exe/hycs_std r/run_stilt.r r/stilt_cli.r


echo "
STILT installation successful.

Relevant manuscripts:
1. Fasoli, B., Lin, J. C., Bowling, D. R., Mitchell, L., and Mendoza, D.: 
   Simulating atmospheric tracer concentrations for spatially distributed 
   receptors: updates to the Stochastic Time-Inverted Lagrangian Transport 
   model's R interface (STILT-R version 2), Geosci. Model Dev., 11, 2813-2824, 
   [10.5194/gmd-11-2813-2018](https://doi.org/10.5194/gmd-11-2813-2018), 2018.
2. Lin, J. C., Gerbig, C., Wofsy, S. C., Andrews, A. E., Daube, B. C., Davis,
   K. J. and Grainger, C. A.: A near-field tool for simulating the upstream 
   influence of atmospheric observations: The Stochastic Time-Inverted Lagrangian
   Transport (STILT) model, J. Geophys. Res., 108(D16), ACH 2-1-ACH 2-17, 
   [10.1029/2002JD003161](https://doi.org/10.1029/2002JD003161), 2003.

We strongly suggest you subscribe to the mailing list at
https://uataq.github.io/stilt/
to be notified of critical code updates.
"
